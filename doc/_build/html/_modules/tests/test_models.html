<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tests.test_models &#8212; blog-api-main  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for tests.test_models</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">models.py用の包括的テストスイート</span>
<span class="sd">SQLAlchemyモデルの構造、リレーションシップ、メソッドをテストします。</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span><span class="p">,</span> <span class="n">MagicMock</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># プロジェクトルートをパスに追加</span>
<span class="n">project_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">project_root</span><span class="p">))</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Article</span><span class="p">,</span> <span class="n">User</span><span class="p">,</span> <span class="n">EmailVerification</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">Base</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">MetaData</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">sessionmaker</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.exc</span><span class="w"> </span><span class="kn">import</span> <span class="n">IntegrityError</span>


<div class="viewcode-block" id="TestArticleModel">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestArticleModel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestArticleModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Articleモデルのテストクラス&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="TestArticleModel.test_article_table_name">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestArticleModel.test_article_table_name">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_article_table_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;テーブル名が正しく設定されていることを確認&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">Article</span><span class="o">.</span><span class="n">__tablename__</span> <span class="o">==</span> <span class="s2">&quot;articles&quot;</span></div>

    
<div class="viewcode-block" id="TestArticleModel.test_article_columns_definition">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestArticleModel.test_article_columns_definition">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_article_columns_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Articleモデルのカラム定義を確認&quot;&quot;&quot;</span>
        <span class="c1"># カラムの存在確認</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">Article</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">Article</span><span class="p">,</span> <span class="s1">&#39;article_id&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">Article</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">Article</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">Article</span><span class="p">,</span> <span class="s1">&#39;user_id&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">Article</span><span class="p">,</span> <span class="s1">&#39;owner&#39;</span><span class="p">)</span>
        
        <span class="c1"># プライマリキーの確認</span>
        <span class="k">assert</span> <span class="n">Article</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">is</span> <span class="kc">True</span>
        <span class="k">assert</span> <span class="n">Article</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="ow">is</span> <span class="kc">True</span>
        
        <span class="c1"># NOT NULLカラムの確認</span>
        <span class="k">assert</span> <span class="n">Article</span><span class="o">.</span><span class="n">article_id</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nullable</span> <span class="ow">is</span> <span class="kc">False</span>
        <span class="k">assert</span> <span class="n">Article</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nullable</span> <span class="ow">is</span> <span class="kc">False</span>
        <span class="k">assert</span> <span class="n">Article</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nullable</span> <span class="ow">is</span> <span class="kc">False</span>
        
        <span class="c1"># 外部キーの確認</span>
        <span class="n">foreign_keys</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">user_id</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">foreign_keys</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">foreign_keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="s2">&quot;users.id&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">foreign_keys</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span></div>

    
<div class="viewcode-block" id="TestArticleModel.test_article_creation">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestArticleModel.test_article_creation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_article_creation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Articleインスタンスの作成テスト&quot;&quot;&quot;</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="p">(</span>
            <span class="n">article_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;テスト記事&quot;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s2">&quot;テスト記事の本文です。&quot;</span>
        <span class="p">)</span>
        
        <span class="k">assert</span> <span class="n">article</span><span class="o">.</span><span class="n">article_id</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">article</span><span class="o">.</span><span class="n">title</span> <span class="o">==</span> <span class="s2">&quot;テスト記事&quot;</span>
        <span class="k">assert</span> <span class="n">article</span><span class="o">.</span><span class="n">body</span> <span class="o">==</span> <span class="s2">&quot;テスト記事の本文です。&quot;</span>
        <span class="k">assert</span> <span class="n">article</span><span class="o">.</span><span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span>  <span class="c1"># 初期値</span></div>

    
<div class="viewcode-block" id="TestArticleModel.test_article_with_user_id">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestArticleModel.test_article_with_user_id">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_article_with_user_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ユーザーIDを含むArticleインスタンスの作成テスト&quot;&quot;&quot;</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="p">(</span>
            <span class="n">article_id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;ユーザー記事&quot;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s2">&quot;ユーザーによる記事の本文です。&quot;</span><span class="p">,</span>
            <span class="n">user_id</span><span class="o">=</span><span class="mi">123</span>
        <span class="p">)</span>
        
        <span class="k">assert</span> <span class="n">article</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="mi">123</span></div>

    
<div class="viewcode-block" id="TestArticleModel.test_article_post_init">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestArticleModel.test_article_post_init">[docs]</a>
    <span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;models.create_logger&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_article_post_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_logger</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;__post_init__メソッドのテスト&quot;&quot;&quot;</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="p">(</span>
            <span class="n">article_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;テスト記事&quot;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s2">&quot;本文&quot;</span>
        <span class="p">)</span>
        
        <span class="c1"># __post_init__が呼ばれた場合のロガー呼び出しを確認</span>
        <span class="c1"># 注意: SQLAlchemyモデルでは通常__post_init__は自動で呼ばれません</span>
        <span class="n">article</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>
        <span class="n">mock_logger</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;Articleインスタンスが作成されました。&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="TestArticleModel.test_article_relationship_definition">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestArticleModel.test_article_relationship_definition">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_article_relationship_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Articleモデルのリレーションシップ定義を確認&quot;&quot;&quot;</span>
        <span class="c1"># ownerリレーションシップの存在確認</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">Article</span><span class="p">,</span> <span class="s1">&#39;owner&#39;</span><span class="p">)</span>
        
        <span class="c1"># リレーションシップの設定確認</span>
        <span class="n">relationship_property</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">property</span>
        <span class="k">assert</span> <span class="n">relationship_property</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">class_</span> <span class="o">==</span> <span class="n">User</span>
        <span class="k">assert</span> <span class="n">relationship_property</span><span class="o">.</span><span class="n">back_populates</span> <span class="o">==</span> <span class="s2">&quot;blogs&quot;</span></div>
</div>



<div class="viewcode-block" id="TestUserModel">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestUserModel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestUserModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Userモデルのテストクラス&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="TestUserModel.test_user_table_name">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestUserModel.test_user_table_name">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_user_table_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;テーブル名が正しく設定されていることを確認&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">User</span><span class="o">.</span><span class="n">__tablename__</span> <span class="o">==</span> <span class="s2">&quot;users&quot;</span></div>

    
<div class="viewcode-block" id="TestUserModel.test_user_columns_definition">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestUserModel.test_user_columns_definition">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_user_columns_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Userモデルのカラム定義を確認&quot;&quot;&quot;</span>
        <span class="c1"># カラムの存在確認</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="s1">&#39;is_active&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="s1">&#39;blogs&#39;</span><span class="p">)</span>
        
        <span class="c1"># プライマリキーの確認</span>
        <span class="k">assert</span> <span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">is</span> <span class="kc">True</span>
        <span class="k">assert</span> <span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="ow">is</span> <span class="kc">True</span>
        
        <span class="c1"># デフォルト値の確認</span>
        <span class="k">assert</span> <span class="n">User</span><span class="o">.</span><span class="n">is_active</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">arg</span> <span class="ow">is</span> <span class="kc">True</span></div>

    
<div class="viewcode-block" id="TestUserModel.test_user_creation">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestUserModel.test_user_creation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_user_creation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Userインスタンスの作成テスト&quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;テストユーザー&quot;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="s2">&quot;hashed_password&quot;</span>
        <span class="p">)</span>
        
        <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;テストユーザー&quot;</span>
        <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="s2">&quot;test@example.com&quot;</span>
        <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="o">==</span> <span class="s2">&quot;hashed_password&quot;</span>
        <span class="c1"># is_activeはデータベースレベルでのデフォルト値なので、</span>
        <span class="c1"># インスタンス作成時点では None の場合がある</span>
        <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span> <span class="ow">is</span> <span class="kc">True</span></div>

    
<div class="viewcode-block" id="TestUserModel.test_user_optional_fields">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestUserModel.test_user_optional_fields">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_user_optional_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Userのオプショナルフィールドのテスト&quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span>
        
        <span class="c1"># オプショナルフィールドがNoneでも問題ないことを確認</span>
        <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="c1"># is_activeは明示的に設定されない限りNoneの場合がある</span>
        <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span> <span class="ow">is</span> <span class="kc">True</span></div>

    
<div class="viewcode-block" id="TestUserModel.test_user_is_active_custom_value">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestUserModel.test_user_is_active_custom_value">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_user_is_active_custom_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;is_activeフィールドのカスタム値テスト&quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;無効ユーザー&quot;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s2">&quot;inactive@example.com&quot;</span><span class="p">,</span>
            <span class="n">is_active</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        
        <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span> <span class="ow">is</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="TestUserModel.test_user_relationship_definition">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestUserModel.test_user_relationship_definition">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_user_relationship_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Userモデルのリレーションシップ定義を確認&quot;&quot;&quot;</span>
        <span class="c1"># blogsリレーションシップの存在確認</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="s1">&#39;blogs&#39;</span><span class="p">)</span>
        
        <span class="c1"># リレーションシップの設定確認</span>
        <span class="n">relationship_property</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">blogs</span><span class="o">.</span><span class="n">property</span>
        <span class="k">assert</span> <span class="n">relationship_property</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">class_</span> <span class="o">==</span> <span class="n">Article</span>
        <span class="k">assert</span> <span class="n">relationship_property</span><span class="o">.</span><span class="n">back_populates</span> <span class="o">==</span> <span class="s2">&quot;owner&quot;</span></div>
</div>



<div class="viewcode-block" id="TestEmailVerificationModel">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestEmailVerificationModel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestEmailVerificationModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;EmailVerificationモデルのテストクラス&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="TestEmailVerificationModel.test_email_verification_table_name">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestEmailVerificationModel.test_email_verification_table_name">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_email_verification_table_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;テーブル名が正しく設定されていることを確認&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">EmailVerification</span><span class="o">.</span><span class="n">__tablename__</span> <span class="o">==</span> <span class="s1">&#39;email_verifications&#39;</span></div>

    
<div class="viewcode-block" id="TestEmailVerificationModel.test_email_verification_columns_definition">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestEmailVerificationModel.test_email_verification_columns_definition">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_email_verification_columns_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;EmailVerificationモデルのカラム定義を確認&quot;&quot;&quot;</span>
        <span class="c1"># カラムの存在確認</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">EmailVerification</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">EmailVerification</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">EmailVerification</span><span class="p">,</span> <span class="s1">&#39;token&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">EmailVerification</span><span class="p">,</span> <span class="s1">&#39;password_hash&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">EmailVerification</span><span class="p">,</span> <span class="s1">&#39;is_verified&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">EmailVerification</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">EmailVerification</span><span class="p">,</span> <span class="s1">&#39;expires_at&#39;</span><span class="p">)</span>
        
        <span class="c1"># プライマリキーの確認</span>
        <span class="k">assert</span> <span class="n">EmailVerification</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">is</span> <span class="kc">True</span>
        
        <span class="c1"># ユニーク制約の確認</span>
        <span class="k">assert</span> <span class="n">EmailVerification</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span> <span class="ow">is</span> <span class="kc">True</span>
        <span class="k">assert</span> <span class="n">EmailVerification</span><span class="o">.</span><span class="n">token</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span> <span class="ow">is</span> <span class="kc">True</span>
        
        <span class="c1"># NOT NULL制約の確認</span>
        <span class="k">assert</span> <span class="n">EmailVerification</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nullable</span> <span class="ow">is</span> <span class="kc">False</span>
        <span class="k">assert</span> <span class="n">EmailVerification</span><span class="o">.</span><span class="n">token</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nullable</span> <span class="ow">is</span> <span class="kc">False</span>
        
        <span class="c1"># デフォルト値の確認</span>
        <span class="k">assert</span> <span class="n">EmailVerification</span><span class="o">.</span><span class="n">is_verified</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">arg</span> <span class="ow">is</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="TestEmailVerificationModel.test_email_verification_creation">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestEmailVerificationModel.test_email_verification_creation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_email_verification_creation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;EmailVerificationインスタンスの作成テスト&quot;&quot;&quot;</span>
        <span class="n">verification</span> <span class="o">=</span> <span class="n">EmailVerification</span><span class="p">(</span>
            <span class="n">email</span><span class="o">=</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">,</span>
            <span class="n">token</span><span class="o">=</span><span class="s2">&quot;test_token_123&quot;</span><span class="p">,</span>
            <span class="n">password_hash</span><span class="o">=</span><span class="s2">&quot;hashed_password&quot;</span>
        <span class="p">)</span>
        
        <span class="k">assert</span> <span class="n">verification</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="s2">&quot;test@example.com&quot;</span>
        <span class="k">assert</span> <span class="n">verification</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;test_token_123&quot;</span>
        <span class="k">assert</span> <span class="n">verification</span><span class="o">.</span><span class="n">password_hash</span> <span class="o">==</span> <span class="s2">&quot;hashed_password&quot;</span>
        <span class="c1"># is_verifiedはデータベースレベルでのデフォルト値なので、</span>
        <span class="c1"># インスタンス作成時点では None の場合がある</span>
        <span class="k">assert</span> <span class="n">verification</span><span class="o">.</span><span class="n">is_verified</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">verification</span><span class="o">.</span><span class="n">is_verified</span> <span class="ow">is</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="TestEmailVerificationModel.test_email_verification_with_datetime">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestEmailVerificationModel.test_email_verification_with_datetime">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_email_verification_with_datetime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;日時フィールドを含むEmailVerificationのテスト&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="n">expires</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
        
        <span class="n">verification</span> <span class="o">=</span> <span class="n">EmailVerification</span><span class="p">(</span>
            <span class="n">email</span><span class="o">=</span><span class="s2">&quot;time@example.com&quot;</span><span class="p">,</span>
            <span class="n">token</span><span class="o">=</span><span class="s2">&quot;time_token&quot;</span><span class="p">,</span>
            <span class="n">created_at</span><span class="o">=</span><span class="n">now</span><span class="p">,</span>
            <span class="n">expires_at</span><span class="o">=</span><span class="n">expires</span>
        <span class="p">)</span>
        
        <span class="k">assert</span> <span class="n">verification</span><span class="o">.</span><span class="n">created_at</span> <span class="o">==</span> <span class="n">now</span>
        <span class="k">assert</span> <span class="n">verification</span><span class="o">.</span><span class="n">expires_at</span> <span class="o">==</span> <span class="n">expires</span></div>

    
<div class="viewcode-block" id="TestEmailVerificationModel.test_create_verification_class_method">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestEmailVerificationModel.test_create_verification_class_method">[docs]</a>
    <span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;models.uuid4&#39;</span><span class="p">)</span>
    <span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;models.datetime&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_verification_class_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_datetime</span><span class="p">,</span> <span class="n">mock_uuid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;create_verificationクラスメソッドのテスト&quot;&quot;&quot;</span>
        <span class="c1"># モックの設定</span>
        <span class="n">mock_now</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">mock_datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_now</span>
        <span class="n">mock_uuid</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_uuid</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="fm">__str__</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;mocked-uuid-token&quot;</span>
        
        <span class="c1"># メソッドの実行</span>
        <span class="n">verification</span> <span class="o">=</span> <span class="n">EmailVerification</span><span class="o">.</span><span class="n">create_verification</span><span class="p">(</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">)</span>
        
        <span class="c1"># 結果の確認</span>
        <span class="k">assert</span> <span class="n">verification</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="s2">&quot;test@example.com&quot;</span>
        <span class="k">assert</span> <span class="n">verification</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;mocked-uuid-token&quot;</span>
        <span class="k">assert</span> <span class="n">verification</span><span class="o">.</span><span class="n">expires_at</span> <span class="o">==</span> <span class="n">mock_now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
        
        <span class="c1"># モックが正しく呼ばれたことを確認</span>
        <span class="n">mock_datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="o">.</span><span class="n">assert_called</span><span class="p">()</span>
        <span class="n">mock_uuid</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="TestEmailVerificationModel.test_create_verification_returns_instance">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestEmailVerificationModel.test_create_verification_returns_instance">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_verification_returns_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;create_verificationが正しいインスタンスを返すことを確認&quot;&quot;&quot;</span>
        <span class="n">verification</span> <span class="o">=</span> <span class="n">EmailVerification</span><span class="o">.</span><span class="n">create_verification</span><span class="p">(</span><span class="s2">&quot;instance@example.com&quot;</span><span class="p">)</span>
        
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">verification</span><span class="p">,</span> <span class="n">EmailVerification</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">verification</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="s2">&quot;instance@example.com&quot;</span>
        <span class="k">assert</span> <span class="n">verification</span><span class="o">.</span><span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">verification</span><span class="o">.</span><span class="n">token</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>  <span class="c1"># UUIDが生成されている</span>
        <span class="k">assert</span> <span class="n">verification</span><span class="o">.</span><span class="n">expires_at</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        
        <span class="c1"># 有効期限が現在時刻より後であることを確認</span>
        <span class="k">assert</span> <span class="n">verification</span><span class="o">.</span><span class="n">expires_at</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="TestModelRelationships">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestModelRelationships">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestModelRelationships</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;モデル間のリレーションシップのテスト&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="TestModelRelationships.test_article_user_relationship_consistency">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestModelRelationships.test_article_user_relationship_consistency">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_article_user_relationship_consistency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ArticleとUserのリレーションシップの整合性テスト&quot;&quot;&quot;</span>
        <span class="c1"># Articleのownerリレーションシップ</span>
        <span class="n">article_relationship</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">property</span>
        <span class="k">assert</span> <span class="n">article_relationship</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">class_</span> <span class="o">==</span> <span class="n">User</span>
        <span class="k">assert</span> <span class="n">article_relationship</span><span class="o">.</span><span class="n">back_populates</span> <span class="o">==</span> <span class="s2">&quot;blogs&quot;</span>
        
        <span class="c1"># Userのblogsリレーションシップ</span>
        <span class="n">user_relationship</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">blogs</span><span class="o">.</span><span class="n">property</span>
        <span class="k">assert</span> <span class="n">user_relationship</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">class_</span> <span class="o">==</span> <span class="n">Article</span>
        <span class="k">assert</span> <span class="n">user_relationship</span><span class="o">.</span><span class="n">back_populates</span> <span class="o">==</span> <span class="s2">&quot;owner&quot;</span></div>

    
<div class="viewcode-block" id="TestModelRelationships.test_foreign_key_consistency">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestModelRelationships.test_foreign_key_consistency">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_foreign_key_consistency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;外部キーの整合性テスト&quot;&quot;&quot;</span>
        <span class="c1"># Article.user_idがusers.idを参照していることを確認</span>
        <span class="n">foreign_keys</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">user_id</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">foreign_keys</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">foreign_keys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        
        <span class="n">foreign_key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">foreign_keys</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">foreign_key</span><span class="o">.</span><span class="n">column</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;users&quot;</span>
        <span class="k">assert</span> <span class="n">foreign_key</span><span class="o">.</span><span class="n">column</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;id&quot;</span></div>
</div>



<div class="viewcode-block" id="TestModelTableStructure">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestModelTableStructure">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestModelTableStructure</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;モデルのテーブル構造テスト&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="TestModelTableStructure.test_all_models_inherit_from_base">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestModelTableStructure.test_all_models_inherit_from_base">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_all_models_inherit_from_base</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;すべてのモデルがBaseクラスを継承していることを確認&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">Article</span><span class="p">,</span> <span class="n">Base</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">Base</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">EmailVerification</span><span class="p">,</span> <span class="n">Base</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="TestModelTableStructure.test_table_names_are_unique">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestModelTableStructure.test_table_names_are_unique">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_table_names_are_unique</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;テーブル名がユニークであることを確認&quot;&quot;&quot;</span>
        <span class="n">table_names</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">Article</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">,</span>
            <span class="n">User</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">,</span>
            <span class="n">EmailVerification</span><span class="o">.</span><span class="n">__tablename__</span>
        <span class="p">}</span>
        
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">table_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>  <span class="c1"># 3つのモデルで3つの異なるテーブル名</span></div>

    
<div class="viewcode-block" id="TestModelTableStructure.test_model_docstrings_exist">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestModelTableStructure.test_model_docstrings_exist">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_model_docstrings_exist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;各モデルにドキュメントが存在することを確認&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">Article</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">User</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">EmailVerification</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        
        <span class="c1"># ドキュメントが空でないことを確認</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">Article</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">EmailVerification</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span></div>
</div>



<div class="viewcode-block" id="TestModelsIntegration">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestModelsIntegration">[docs]</a>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">integration</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TestModelsIntegration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;モデルの統合テスト（データベース操作を含む）&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="TestModelsIntegration.test_engine">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestModelsIntegration.test_engine">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_engine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;テスト用のインメモリデータベースエンジン&quot;&quot;&quot;</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;sqlite:///:memory:&quot;</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">engine</span></div>

    
<div class="viewcode-block" id="TestModelsIntegration.test_session">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestModelsIntegration.test_session">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_engine</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;テスト用のデータベースセッション&quot;&quot;&quot;</span>
        <span class="n">TestingSessionLocal</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">test_engine</span><span class="p">)</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">TestingSessionLocal</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">session</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="TestModelsIntegration.test_user_article_relationship_in_db">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestModelsIntegration.test_user_article_relationship_in_db">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_user_article_relationship_in_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_session</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;データベースでのUser-Articleリレーションシップテスト&quot;&quot;&quot;</span>
        <span class="c1"># ユーザーを作成</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;統合テストユーザー&quot;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s2">&quot;integration@example.com&quot;</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="s2">&quot;test_password&quot;</span>
        <span class="p">)</span>
        <span class="n">test_session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">test_session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>  <span class="c1"># IDを取得するためにflush</span>
        
        <span class="c1"># 記事を作成</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="p">(</span>
            <span class="n">article_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;統合テスト記事&quot;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s2">&quot;統合テストの本文&quot;</span><span class="p">,</span>
            <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span>
        <span class="n">test_session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
        <span class="n">test_session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        
        <span class="c1"># リレーションシップが正しく動作することを確認</span>
        <span class="k">assert</span> <span class="n">article</span><span class="o">.</span><span class="n">owner</span> <span class="o">==</span> <span class="n">user</span>
        <span class="k">assert</span> <span class="n">article</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">blogs</span></div>

    
<div class="viewcode-block" id="TestModelsIntegration.test_email_verification_in_db">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestModelsIntegration.test_email_verification_in_db">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_email_verification_in_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_session</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;データベースでのEmailVerificationテスト&quot;&quot;&quot;</span>
        <span class="n">verification</span> <span class="o">=</span> <span class="n">EmailVerification</span><span class="o">.</span><span class="n">create_verification</span><span class="p">(</span><span class="s2">&quot;db@example.com&quot;</span><span class="p">)</span>
        <span class="n">test_session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">verification</span><span class="p">)</span>
        <span class="n">test_session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        
        <span class="c1"># データベースから取得</span>
        <span class="n">retrieved</span> <span class="o">=</span> <span class="n">test_session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">EmailVerification</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
            <span class="n">email</span><span class="o">=</span><span class="s2">&quot;db@example.com&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        
        <span class="k">assert</span> <span class="n">retrieved</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">retrieved</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="s2">&quot;db@example.com&quot;</span>
        <span class="k">assert</span> <span class="n">retrieved</span><span class="o">.</span><span class="n">is_verified</span> <span class="ow">is</span> <span class="kc">False</span>
        <span class="k">assert</span> <span class="n">retrieved</span><span class="o">.</span><span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>

    
<div class="viewcode-block" id="TestModelsIntegration.test_unique_constraints">
<a class="viewcode-back" href="../../tests.test_models.html#tests.test_models.TestModelsIntegration.test_unique_constraints">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_unique_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_session</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ユニーク制約のテスト&quot;&quot;&quot;</span>
        <span class="c1"># 最初のEmailVerificationを作成</span>
        <span class="n">verification1</span> <span class="o">=</span> <span class="n">EmailVerification</span><span class="p">(</span>
            <span class="n">email</span><span class="o">=</span><span class="s2">&quot;unique@example.com&quot;</span><span class="p">,</span>
            <span class="n">token</span><span class="o">=</span><span class="s2">&quot;unique_token_1&quot;</span>
        <span class="p">)</span>
        <span class="n">test_session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">verification1</span><span class="p">)</span>
        <span class="n">test_session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        
        <span class="c1"># 同じemailで2つ目を作成しようとする</span>
        <span class="n">verification2</span> <span class="o">=</span> <span class="n">EmailVerification</span><span class="p">(</span>
            <span class="n">email</span><span class="o">=</span><span class="s2">&quot;unique@example.com&quot;</span><span class="p">,</span>  <span class="c1"># 同じemail</span>
            <span class="n">token</span><span class="o">=</span><span class="s2">&quot;unique_token_2&quot;</span>
        <span class="p">)</span>
        <span class="n">test_session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">verification2</span><span class="p">)</span>
        
        <span class="c1"># ユニーク制約違反でエラーが発生することを確認</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">):</span>
            <span class="n">test_session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">blog-api-main</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../custom_token.html">custom_token module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../database.html">database module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generate_summary_report.html">generate_summary_report module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hashing.html">hashing module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logger.html">logger package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../main.html">main module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../models.html">models module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../oauth2.html">oauth2 module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../routers.html">routers package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../run_continuous_tests.html">run_continuous_tests module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../schemas.html">schemas module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tests.html">tests package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../update_main_bug_history.html">update_main_bug_history module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utils.html">utils package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Author.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>