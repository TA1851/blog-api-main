<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tests.test_article_router &#8212; blog-api-main  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for tests.test_article_router</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">記事ルーターの包括的テストスイート</span>

<span class="sd">このテストスイートは routers/article.py の全ての機能をテストします:</span>
<span class="sd">- 認証ユーザーの記事管理 (CRUD操作)</span>
<span class="sd">- パブリック記事の取得と検索</span>
<span class="sd">- 記事の一覧取得とページネーション</span>
<span class="sd">- 検索機能とMarkdown変換</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">urllib.parse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncMock</span><span class="p">,</span> <span class="n">MagicMock</span><span class="p">,</span> <span class="n">patch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">status</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.testclient</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestClient</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">func</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">routers.article</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">router</span><span class="p">,</span>
    <span class="n">all_fetch</span><span class="p">,</span>
    <span class="n">get_article</span><span class="p">,</span>
    <span class="n">create_article</span><span class="p">,</span>
    <span class="n">update_article</span><span class="p">,</span>
    <span class="n">delete_article</span><span class="p">,</span>
    <span class="n">get_public_articles</span><span class="p">,</span>
    <span class="n">search_public_articles</span><span class="p">,</span>
    <span class="n">get_public_article_by_id</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">schemas</span><span class="w"> </span><span class="kn">import</span> <span class="n">ArticleBase</span><span class="p">,</span> <span class="n">PublicArticle</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Article</span><span class="p">,</span> <span class="n">User</span> <span class="k">as</span> <span class="n">UserModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">main</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span>


<div class="viewcode-block" id="TestArticleRouterConfiguration">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestArticleRouterConfiguration">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestArticleRouterConfiguration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;記事ルーター設定のテスト&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="TestArticleRouterConfiguration.test_router_configuration">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestArticleRouterConfiguration.test_router_configuration">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_router_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ルーター設定のテスト&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">router</span><span class="o">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="s2">&quot;/api/v1&quot;</span>
        <span class="k">assert</span> <span class="s2">&quot;articles&quot;</span> <span class="ow">in</span> <span class="n">router</span><span class="o">.</span><span class="n">tags</span></div>

    
<div class="viewcode-block" id="TestArticleRouterConfiguration.test_router_endpoints_exist">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestArticleRouterConfiguration.test_router_endpoints_exist">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_router_endpoints_exist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;エンドポイントが存在することを確認&quot;&quot;&quot;</span>
        <span class="n">routes</span> <span class="o">=</span> <span class="p">[</span><span class="n">route</span><span class="o">.</span><span class="n">path</span> <span class="k">for</span> <span class="n">route</span> <span class="ow">in</span> <span class="n">router</span><span class="o">.</span><span class="n">routes</span><span class="p">]</span>
        
        <span class="c1"># 認証が必要なエンドポイント</span>
        <span class="k">assert</span> <span class="s2">&quot;/api/v1/articles&quot;</span> <span class="ow">in</span> <span class="n">routes</span>  <span class="c1"># GET, POST</span>
        <span class="k">assert</span> <span class="s2">&quot;/api/v1/articles/</span><span class="si">{id}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">routes</span>  <span class="c1"># GET</span>
        <span class="k">assert</span> <span class="s2">&quot;/api/v1/articles&quot;</span> <span class="ow">in</span> <span class="n">routes</span>  <span class="c1"># PUT, DELETE</span>
        
        <span class="c1"># パブリックエンドポイント</span>
        <span class="k">assert</span> <span class="s2">&quot;/api/v1/public/articles&quot;</span> <span class="ow">in</span> <span class="n">routes</span>  <span class="c1"># GET</span>
        <span class="k">assert</span> <span class="s2">&quot;/api/v1/public/articles/search&quot;</span> <span class="ow">in</span> <span class="n">routes</span>  <span class="c1"># GET</span>
        <span class="k">assert</span> <span class="s2">&quot;/api/v1/public/articles/</span><span class="si">{article_id}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">routes</span>  <span class="c1"># GET</span></div>
</div>



<div class="viewcode-block" id="TestAllFetchEndpoint">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestAllFetchEndpoint">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestAllFetchEndpoint</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;all_fetch エンドポイントのテスト&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="TestAllFetchEndpoint.mock_db">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestAllFetchEndpoint.mock_db">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mock_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;モックデータベースセッション&quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">Session</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db</span></div>

    
<div class="viewcode-block" id="TestAllFetchEndpoint.mock_current_user">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestAllFetchEndpoint.mock_current_user">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mock_current_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;モック現在ユーザー&quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">123</span>
        <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;test@example.com&quot;</span>
        <span class="k">return</span> <span class="n">user</span></div>

    
<div class="viewcode-block" id="TestAllFetchEndpoint.sample_articles">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestAllFetchEndpoint.sample_articles">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sample_articles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;サンプル記事データ&quot;&quot;&quot;</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">article</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
            <span class="n">article</span><span class="o">.</span><span class="n">article_id</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">article</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;テスト記事 </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">article</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;テスト記事の本文 </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">article</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="mi">123</span>
            <span class="n">articles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">articles</span></div>

    
<div class="viewcode-block" id="TestAllFetchEndpoint.test_all_fetch_without_limit">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestAllFetchEndpoint.test_all_fetch_without_limit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_all_fetch_without_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">,</span> <span class="n">sample_articles</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;制限なしで全記事を取得するテスト&quot;&quot;&quot;</span>
        <span class="c1"># データベースクエリのモック設定</span>
        <span class="n">mock_query</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">count</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">limit</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">sample_articles</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">all_fetch</span><span class="p">(</span><span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">article_id</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">title</span> <span class="o">==</span> <span class="s2">&quot;テスト記事 1&quot;</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="mi">123</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">assert_called</span><span class="p">()</span></div>

        
<div class="viewcode-block" id="TestAllFetchEndpoint.test_all_fetch_with_limit">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestAllFetchEndpoint.test_all_fetch_with_limit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_all_fetch_with_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">,</span> <span class="n">sample_articles</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;制限ありで記事を取得するテスト&quot;&quot;&quot;</span>
        <span class="n">limited_articles</span> <span class="o">=</span> <span class="n">sample_articles</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        
        <span class="n">mock_query</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">count</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">limit</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">limited_articles</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">all_fetch</span><span class="p">(</span><span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">article_id</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">article_id</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">limit</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="TestAllFetchEndpoint.test_all_fetch_no_articles">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestAllFetchEndpoint.test_all_fetch_no_articles">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_all_fetch_no_articles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;記事が存在しない場合のテスト&quot;&quot;&quot;</span>
        <span class="n">mock_query</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">count</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">all_fetch</span><span class="p">(</span><span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        
        <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="p">[]</span></div>

    
<div class="viewcode-block" id="TestAllFetchEndpoint.test_all_fetch_database_error">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestAllFetchEndpoint.test_all_fetch_database_error">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_all_fetch_database_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;データベースエラーの場合のテスト&quot;&quot;&quot;</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Database error&quot;</span><span class="p">)</span>
        
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">HTTPException</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">all_fetch</span><span class="p">(</span><span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        
        <span class="k">assert</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
        <span class="k">assert</span> <span class="s2">&quot;Articles not found&quot;</span> <span class="ow">in</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">detail</span></div>
</div>



<div class="viewcode-block" id="TestGetArticleEndpoint">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestGetArticleEndpoint">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestGetArticleEndpoint</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;get_article エンドポイントのテスト&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="TestGetArticleEndpoint.mock_db">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestGetArticleEndpoint.mock_db">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mock_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;モックデータベースセッション&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">MagicMock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">Session</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="TestGetArticleEndpoint.sample_article">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestGetArticleEndpoint.sample_article">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sample_article</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;サンプル記事&quot;&quot;&quot;</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">article</span><span class="o">.</span><span class="n">article_id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">article</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;テスト記事&quot;</span>
        <span class="n">article</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;テスト記事の本文&quot;</span>
        <span class="n">article</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="mi">123</span>
        <span class="k">return</span> <span class="n">article</span></div>

    
<div class="viewcode-block" id="TestGetArticleEndpoint.test_get_article_success">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestGetArticleEndpoint.test_get_article_success">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_get_article_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">sample_article</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;記事取得成功のテスト&quot;&quot;&quot;</span>
        <span class="n">mock_query</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">sample_article</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">get_article</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">))</span>
        
        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">article_id</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">title</span> <span class="o">==</span> <span class="s2">&quot;テスト記事&quot;</span>
        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="mi">123</span></div>

    
<div class="viewcode-block" id="TestGetArticleEndpoint.test_get_article_not_found">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestGetArticleEndpoint.test_get_article_not_found">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_get_article_not_found</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;記事が見つからない場合のテスト&quot;&quot;&quot;</span>
        <span class="n">mock_query</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">HTTPException</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">get_article</span><span class="p">(</span><span class="mi">999</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">))</span>
        
        <span class="k">assert</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
        <span class="k">assert</span> <span class="s2">&quot;Article not found 999&quot;</span> <span class="ow">in</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">detail</span></div>

    
<div class="viewcode-block" id="TestGetArticleEndpoint.test_get_article_database_error">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestGetArticleEndpoint.test_get_article_database_error">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_get_article_database_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;データベースエラーの場合のテスト&quot;&quot;&quot;</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Database error&quot;</span><span class="p">)</span>
        
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">HTTPException</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">get_article</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">))</span>
        
        <span class="k">assert</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span></div>
</div>



<div class="viewcode-block" id="TestCreateArticleEndpoint">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestCreateArticleEndpoint">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestCreateArticleEndpoint</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;create_article エンドポイントのテスト&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="TestCreateArticleEndpoint.mock_db">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestCreateArticleEndpoint.mock_db">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mock_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;モックデータベースセッション&quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">Session</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db</span></div>

    
<div class="viewcode-block" id="TestCreateArticleEndpoint.mock_current_user">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestCreateArticleEndpoint.mock_current_user">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mock_current_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;モック現在ユーザー&quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">123</span>
        <span class="k">return</span> <span class="n">user</span></div>

    
<div class="viewcode-block" id="TestCreateArticleEndpoint.valid_article">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestCreateArticleEndpoint.valid_article">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">valid_article</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;有効な記事データ&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ArticleBase</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;新規記事&quot;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s2">&quot;新規記事の本文です。&quot;</span>
        <span class="p">)</span></div>

    
<div class="viewcode-block" id="TestCreateArticleEndpoint.test_create_article_success">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestCreateArticleEndpoint.test_create_article_success">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_article_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">,</span> <span class="n">valid_article</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;記事作成成功のテスト&quot;&quot;&quot;</span>
        <span class="c1"># func.maxのモック</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">scalar</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">5</span>
        
        <span class="c1"># 新規記事のモック</span>
        <span class="n">new_article</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">new_article</span><span class="o">.</span><span class="n">article_id</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="n">new_article</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;新規記事&quot;</span>
        <span class="n">new_article</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;新規記事の本文です。&quot;</span>
        <span class="n">new_article</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="mi">123</span>
        
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;routers.article.Article&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_article_class</span><span class="p">:</span>
            <span class="n">mock_article_class</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">new_article</span>
            
            <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">create_article</span><span class="p">(</span><span class="n">valid_article</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">))</span>
            
            <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">article_id</span> <span class="o">==</span> <span class="mi">6</span>
            <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">title</span> <span class="o">==</span> <span class="s2">&quot;新規記事&quot;</span>
            <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="mi">123</span>
            <span class="n">mock_db</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
            <span class="n">mock_db</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
            <span class="n">mock_db</span><span class="o">.</span><span class="n">refresh</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="TestCreateArticleEndpoint.test_create_article_empty_title">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestCreateArticleEndpoint.test_create_article_empty_title">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_article_empty_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;空のタイトルの場合のテスト&quot;&quot;&quot;</span>
        <span class="n">invalid_article</span> <span class="o">=</span> <span class="n">ArticleBase</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s2">&quot;本文はあります&quot;</span>
        <span class="p">)</span>
        
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">HTTPException</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">create_article</span><span class="p">(</span><span class="n">invalid_article</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">))</span>
        
        <span class="k">assert</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
        <span class="k">assert</span> <span class="s2">&quot;タイトルは必須項目です&quot;</span> <span class="ow">in</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">detail</span></div>

    
<div class="viewcode-block" id="TestCreateArticleEndpoint.test_create_article_none_title">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestCreateArticleEndpoint.test_create_article_none_title">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_article_none_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Noneタイトルの場合のテスト（Pydanticバリデーション）&quot;&quot;&quot;</span>
        <span class="c1"># Pydanticスキーマが直接Noneを受け入れないため、</span>
        <span class="c1"># バリデーションエラーをテスト</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
            <span class="n">ArticleBase</span><span class="p">(</span>
                <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">body</span><span class="o">=</span><span class="s2">&quot;本文はあります&quot;</span>
            <span class="p">)</span>
        
        <span class="c1"># Pydanticバリデーションエラーが発生することを確認</span>
        <span class="k">assert</span> <span class="s2">&quot;Input should be a valid string&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="TestCreateArticleEndpoint.test_create_article_empty_body">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestCreateArticleEndpoint.test_create_article_empty_body">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_article_empty_body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;空の本文の場合のテスト&quot;&quot;&quot;</span>
        <span class="n">invalid_article</span> <span class="o">=</span> <span class="n">ArticleBase</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;タイトルはあります&quot;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="p">)</span>
        
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">HTTPException</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">create_article</span><span class="p">(</span><span class="n">invalid_article</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">))</span>
        
        <span class="k">assert</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
        <span class="k">assert</span> <span class="s2">&quot;本文は必須項目です&quot;</span> <span class="ow">in</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">detail</span></div>

    
<div class="viewcode-block" id="TestCreateArticleEndpoint.test_create_article_none_body">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestCreateArticleEndpoint.test_create_article_none_body">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_article_none_body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;None本文の場合のテスト（Pydanticバリデーション）&quot;&quot;&quot;</span>
        <span class="c1"># Pydanticスキーマが直接Noneを受け入れないため、</span>
        <span class="c1"># バリデーションエラーをテスト</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
            <span class="n">ArticleBase</span><span class="p">(</span>
                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;タイトルはあります&quot;</span><span class="p">,</span>
                <span class="n">body</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">)</span>
        
        <span class="c1"># Pydanticバリデーションエラーが発生することを確認</span>
        <span class="k">assert</span> <span class="s2">&quot;Input should be a valid string&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="TestCreateArticleEndpoint.test_create_article_whitespace_only">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestCreateArticleEndpoint.test_create_article_whitespace_only">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_article_whitespace_only</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;空白のみのタイトル・本文の場合のテスト&quot;&quot;&quot;</span>
        <span class="n">invalid_article</span> <span class="o">=</span> <span class="n">ArticleBase</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;   &quot;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s2">&quot;   &quot;</span>
        <span class="p">)</span>
        
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">HTTPException</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">create_article</span><span class="p">(</span><span class="n">invalid_article</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">))</span>
        
        <span class="k">assert</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
        <span class="k">assert</span> <span class="s2">&quot;タイトルは必須項目です&quot;</span> <span class="ow">in</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">detail</span></div>

    
<div class="viewcode-block" id="TestCreateArticleEndpoint.test_create_article_auto_increment">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestCreateArticleEndpoint.test_create_article_auto_increment">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_article_auto_increment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">,</span> <span class="n">valid_article</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;記事IDの自動採番テスト&quot;&quot;&quot;</span>
        <span class="c1"># 最大記事IDを10に設定</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">scalar</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">10</span>
        
        <span class="n">new_article</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">new_article</span><span class="o">.</span><span class="n">article_id</span> <span class="o">=</span> <span class="mi">11</span>
        <span class="n">new_article</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;新規記事&quot;</span>
        <span class="n">new_article</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;新規記事の本文です。&quot;</span>
        <span class="n">new_article</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="mi">123</span>
        
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;routers.article.Article&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_article_class</span><span class="p">:</span>
            <span class="n">mock_article_class</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">new_article</span>
            
            <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">create_article</span><span class="p">(</span><span class="n">valid_article</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">))</span>
            
            <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">article_id</span> <span class="o">==</span> <span class="mi">11</span>
            <span class="c1"># Article作成時に正しいIDが渡されることを確認</span>
            <span class="n">mock_article_class</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
                <span class="n">article_id</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;新規記事&quot;</span><span class="p">,</span>
                <span class="n">body</span><span class="o">=</span><span class="s2">&quot;新規記事の本文です。&quot;</span><span class="p">,</span>
                <span class="n">user_id</span><span class="o">=</span><span class="mi">123</span>
            <span class="p">)</span></div>

    
<div class="viewcode-block" id="TestCreateArticleEndpoint.test_create_article_no_existing_articles">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestCreateArticleEndpoint.test_create_article_no_existing_articles">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_article_no_existing_articles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">,</span> <span class="n">valid_article</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;既存記事がない場合のIDテスト&quot;&quot;&quot;</span>
        <span class="c1"># 既存記事なし（None）</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">scalar</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="n">new_article</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">new_article</span><span class="o">.</span><span class="n">article_id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">new_article</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;新規記事&quot;</span>
        <span class="n">new_article</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;新規記事の本文です。&quot;</span>
        <span class="n">new_article</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="mi">123</span>
        
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;routers.article.Article&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_article_class</span><span class="p">:</span>
            <span class="n">mock_article_class</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">new_article</span>
            
            <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">create_article</span><span class="p">(</span><span class="n">valid_article</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">))</span>
            
            <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">article_id</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="c1"># Article作成時にIDが1になることを確認</span>
            <span class="n">mock_article_class</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
                <span class="n">article_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;新規記事&quot;</span><span class="p">,</span>
                <span class="n">body</span><span class="o">=</span><span class="s2">&quot;新規記事の本文です。&quot;</span><span class="p">,</span>
                <span class="n">user_id</span><span class="o">=</span><span class="mi">123</span>
            <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TestUpdateArticleEndpoint">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestUpdateArticleEndpoint">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestUpdateArticleEndpoint</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;update_article エンドポイントのテスト&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="TestUpdateArticleEndpoint.mock_db">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestUpdateArticleEndpoint.mock_db">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mock_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;モックデータベースセッション&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">MagicMock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">Session</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="TestUpdateArticleEndpoint.mock_current_user">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestUpdateArticleEndpoint.mock_current_user">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mock_current_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;モック現在ユーザー&quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">123</span>
        <span class="k">return</span> <span class="n">user</span></div>

    
<div class="viewcode-block" id="TestUpdateArticleEndpoint.existing_article">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestUpdateArticleEndpoint.existing_article">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">existing_article</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;既存記事のモック&quot;&quot;&quot;</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">article</span><span class="o">.</span><span class="n">article_id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">article</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;元のタイトル&quot;</span>
        <span class="n">article</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;元の本文&quot;</span>
        <span class="n">article</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="mi">123</span>
        <span class="k">return</span> <span class="n">article</span></div>

    
<div class="viewcode-block" id="TestUpdateArticleEndpoint.update_data">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestUpdateArticleEndpoint.update_data">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;更新データ&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ArticleBase</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;更新されたタイトル&quot;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s2">&quot;更新された本文&quot;</span>
        <span class="p">)</span></div>

    
<div class="viewcode-block" id="TestUpdateArticleEndpoint.test_update_article_success">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestUpdateArticleEndpoint.test_update_article_success">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_update_article_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">,</span> <span class="n">existing_article</span><span class="p">,</span> <span class="n">update_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;記事更新成功のテスト&quot;&quot;&quot;</span>
        <span class="n">mock_query</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">existing_article</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">update_article</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">update_data</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">))</span>
        
        <span class="c1"># 記事の内容が更新されることを確認</span>
        <span class="k">assert</span> <span class="n">existing_article</span><span class="o">.</span><span class="n">title</span> <span class="o">==</span> <span class="s2">&quot;更新されたタイトル&quot;</span>
        <span class="k">assert</span> <span class="n">existing_article</span><span class="o">.</span><span class="n">body</span> <span class="o">==</span> <span class="s2">&quot;更新された本文&quot;</span>
        
        <span class="c1"># 戻り値の確認</span>
        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">article_id</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">title</span> <span class="o">==</span> <span class="s2">&quot;更新されたタイトル&quot;</span>
        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">body</span> <span class="o">==</span> <span class="s2">&quot;更新された本文&quot;</span>
        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="mi">123</span>
        
        <span class="n">mock_db</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">refresh</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">existing_article</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="TestUpdateArticleEndpoint.test_update_article_not_found">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestUpdateArticleEndpoint.test_update_article_not_found">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_update_article_not_found</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">,</span> <span class="n">update_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;存在しない記事の更新テスト&quot;&quot;&quot;</span>
        <span class="n">mock_query</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">HTTPException</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">update_article</span><span class="p">(</span><span class="mi">999</span><span class="p">,</span> <span class="n">update_data</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">))</span>
        
        <span class="k">assert</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
        <span class="k">assert</span> <span class="s2">&quot;Article not found or you do not have permission&quot;</span> <span class="ow">in</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">detail</span>
        <span class="k">assert</span> <span class="s2">&quot;Article_id:999&quot;</span> <span class="ow">in</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">detail</span></div>

    
<div class="viewcode-block" id="TestUpdateArticleEndpoint.test_update_article_wrong_user">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestUpdateArticleEndpoint.test_update_article_wrong_user">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_update_article_wrong_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">,</span> <span class="n">update_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;他のユーザーの記事更新テスト&quot;&quot;&quot;</span>
        <span class="n">other_user_article</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">other_user_article</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="mi">456</span>  <span class="c1"># 異なるユーザーID</span>
        
        <span class="n">mock_query</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># フィルタリング結果で見つからない</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">HTTPException</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">update_article</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">update_data</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">))</span>
        
        <span class="k">assert</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
        <span class="k">assert</span> <span class="s2">&quot;Article not found or you do not have permission&quot;</span> <span class="ow">in</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">detail</span></div>

    
<div class="viewcode-block" id="TestUpdateArticleEndpoint.test_update_article_empty_title">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestUpdateArticleEndpoint.test_update_article_empty_title">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_update_article_empty_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">,</span> <span class="n">existing_article</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;空のタイトルでの更新テスト&quot;&quot;&quot;</span>
        <span class="n">mock_query</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">existing_article</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        
        <span class="n">invalid_update</span> <span class="o">=</span> <span class="n">ArticleBase</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s2">&quot;更新された本文&quot;</span>
        <span class="p">)</span>
        
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">HTTPException</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">update_article</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">invalid_update</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">))</span>
        
        <span class="k">assert</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
        <span class="k">assert</span> <span class="s2">&quot;タイトルは必須項目です&quot;</span> <span class="ow">in</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">detail</span></div>

    
<div class="viewcode-block" id="TestUpdateArticleEndpoint.test_update_article_empty_body">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestUpdateArticleEndpoint.test_update_article_empty_body">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_update_article_empty_body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">,</span> <span class="n">existing_article</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;空の本文での更新テスト&quot;&quot;&quot;</span>
        <span class="n">mock_query</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">existing_article</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        
        <span class="n">invalid_update</span> <span class="o">=</span> <span class="n">ArticleBase</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;更新されたタイトル&quot;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="p">)</span>
        
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">HTTPException</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">update_article</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">invalid_update</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">))</span>
        
        <span class="k">assert</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
        <span class="k">assert</span> <span class="s2">&quot;本文は必須項目です&quot;</span> <span class="ow">in</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">detail</span></div>

    
<div class="viewcode-block" id="TestUpdateArticleEndpoint.test_update_article_database_error">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestUpdateArticleEndpoint.test_update_article_database_error">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_update_article_database_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">,</span> <span class="n">update_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;データベースエラーのテスト&quot;&quot;&quot;</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Database connection failed&quot;</span><span class="p">)</span>
        
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">HTTPException</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">update_article</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">update_data</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">))</span>
        
        <span class="k">assert</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
        <span class="k">assert</span> <span class="s2">&quot;Article not updated&quot;</span> <span class="ow">in</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">detail</span></div>
</div>



<div class="viewcode-block" id="TestDeleteArticleEndpoint">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestDeleteArticleEndpoint">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestDeleteArticleEndpoint</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;delete_article エンドポイントのテスト&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="TestDeleteArticleEndpoint.mock_db">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestDeleteArticleEndpoint.mock_db">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mock_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;モックデータベースセッション&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">MagicMock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">Session</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="TestDeleteArticleEndpoint.mock_current_user">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestDeleteArticleEndpoint.mock_current_user">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mock_current_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;モック現在ユーザー&quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">123</span>
        <span class="k">return</span> <span class="n">user</span></div>

    
<div class="viewcode-block" id="TestDeleteArticleEndpoint.existing_article">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestDeleteArticleEndpoint.existing_article">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">existing_article</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;既存記事のモック&quot;&quot;&quot;</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">article</span><span class="o">.</span><span class="n">article_id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">article</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="mi">123</span>
        <span class="k">return</span> <span class="n">article</span></div>

    
<div class="viewcode-block" id="TestDeleteArticleEndpoint.test_delete_article_success">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestDeleteArticleEndpoint.test_delete_article_success">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_delete_article_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">,</span> <span class="n">existing_article</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;記事削除成功のテスト&quot;&quot;&quot;</span>
        <span class="n">mock_query</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">existing_article</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">delete_article</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">))</span>
        
        <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">delete</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">existing_article</span><span class="p">)</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="TestDeleteArticleEndpoint.test_delete_article_not_found">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestDeleteArticleEndpoint.test_delete_article_not_found">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_delete_article_not_found</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;存在しない記事の削除テスト&quot;&quot;&quot;</span>
        <span class="n">mock_query</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">HTTPException</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">delete_article</span><span class="p">(</span><span class="mi">999</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">))</span>
        
        <span class="k">assert</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
        <span class="k">assert</span> <span class="s2">&quot;Article not found or you do not have permission&quot;</span> <span class="ow">in</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">detail</span>
        <span class="k">assert</span> <span class="s2">&quot;Article_id:999&quot;</span> <span class="ow">in</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">detail</span></div>

    
<div class="viewcode-block" id="TestDeleteArticleEndpoint.test_delete_article_wrong_user">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestDeleteArticleEndpoint.test_delete_article_wrong_user">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_delete_article_wrong_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;他のユーザーの記事削除テスト&quot;&quot;&quot;</span>
        <span class="n">mock_query</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># フィルタリング結果で見つからない</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">HTTPException</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">delete_article</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">))</span>
        
        <span class="k">assert</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span></div>

    
<div class="viewcode-block" id="TestDeleteArticleEndpoint.test_delete_article_database_error">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestDeleteArticleEndpoint.test_delete_article_database_error">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_delete_article_database_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;データベースエラーのテスト&quot;&quot;&quot;</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Database connection failed&quot;</span><span class="p">)</span>
        
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">HTTPException</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">delete_article</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">))</span>
        
        <span class="k">assert</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
        <span class="k">assert</span> <span class="s2">&quot;Article not deleted&quot;</span> <span class="ow">in</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">detail</span></div>
</div>



<div class="viewcode-block" id="TestGetPublicArticlesEndpoint">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestGetPublicArticlesEndpoint">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestGetPublicArticlesEndpoint</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;get_public_articles エンドポイントのテスト&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="TestGetPublicArticlesEndpoint.mock_db">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestGetPublicArticlesEndpoint.mock_db">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mock_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;モックデータベースセッション&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">MagicMock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">Session</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="TestGetPublicArticlesEndpoint.sample_articles">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestGetPublicArticlesEndpoint.sample_articles">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sample_articles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;サンプル記事データ&quot;&quot;&quot;</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">article</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
            <span class="n">article</span><span class="o">.</span><span class="n">article_id</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">article</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;パブリック記事 </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">article</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;パブリック記事の本文 </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="se">\n\n</span><span class="s2"># 見出し&quot;</span>
            <span class="n">articles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">articles</span></div>

    
<div class="viewcode-block" id="TestGetPublicArticlesEndpoint.test_get_public_articles_without_pagination">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestGetPublicArticlesEndpoint.test_get_public_articles_without_pagination">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_get_public_articles_without_pagination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">sample_articles</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ページネーションなしでパブリック記事取得テスト&quot;&quot;&quot;</span>
        <span class="n">mock_query</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">count</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">order_by</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">offset</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">limit</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">sample_articles</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;routers.article.markdown.Markdown&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_markdown</span><span class="p">:</span>
            <span class="n">mock_md</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
            <span class="n">mock_md</span><span class="o">.</span><span class="n">convert</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&lt;p&gt;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&lt;/p&gt;&quot;</span>
            <span class="n">mock_markdown</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_md</span>
            
            <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">get_public_articles</span><span class="p">(</span><span class="n">mock_db</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">PublicArticle</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">article_id</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">title</span> <span class="o">==</span> <span class="s2">&quot;パブリック記事 1&quot;</span>
            <span class="k">assert</span> <span class="s2">&quot;&lt;p&gt;&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">body_html</span></div>

    
<div class="viewcode-block" id="TestGetPublicArticlesEndpoint.test_get_public_articles_with_limit">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestGetPublicArticlesEndpoint.test_get_public_articles_with_limit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_get_public_articles_with_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">sample_articles</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;制限ありでパブリック記事取得テスト&quot;&quot;&quot;</span>
        <span class="n">limited_articles</span> <span class="o">=</span> <span class="n">sample_articles</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        
        <span class="n">mock_query</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">count</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">order_by</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">offset</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">limit</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">limited_articles</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;routers.article.markdown.Markdown&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_markdown</span><span class="p">:</span>
            <span class="n">mock_md</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
            <span class="n">mock_md</span><span class="o">.</span><span class="n">convert</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&lt;p&gt;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&lt;/p&gt;&quot;</span>
            <span class="n">mock_markdown</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_md</span>
            
            <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">get_public_articles</span><span class="p">(</span><span class="n">mock_db</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
            <span class="n">mock_query</span><span class="o">.</span><span class="n">limit</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="TestGetPublicArticlesEndpoint.test_get_public_articles_with_skip">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestGetPublicArticlesEndpoint.test_get_public_articles_with_skip">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_get_public_articles_with_skip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">sample_articles</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;スキップありでパブリック記事取得テスト&quot;&quot;&quot;</span>
        <span class="n">skipped_articles</span> <span class="o">=</span> <span class="n">sample_articles</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        
        <span class="n">mock_query</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">count</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">order_by</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">offset</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">limit</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">skipped_articles</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;routers.article.markdown.Markdown&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_markdown</span><span class="p">:</span>
            <span class="n">mock_md</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
            <span class="n">mock_md</span><span class="o">.</span><span class="n">convert</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&lt;p&gt;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&lt;/p&gt;&quot;</span>
            <span class="n">mock_markdown</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_md</span>
            
            <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">get_public_articles</span><span class="p">(</span><span class="n">mock_db</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
            <span class="n">mock_query</span><span class="o">.</span><span class="n">offset</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="TestGetPublicArticlesEndpoint.test_get_public_articles_markdown_conversion">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestGetPublicArticlesEndpoint.test_get_public_articles_markdown_conversion">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_get_public_articles_markdown_conversion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Markdown変換のテスト&quot;&quot;&quot;</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">article</span><span class="o">.</span><span class="n">article_id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">article</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Markdownテスト&quot;</span>
        <span class="n">article</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;# 見出し</span><span class="se">\n\n</span><span class="s2">本文です。&quot;</span>
        
        <span class="n">mock_query</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">count</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">order_by</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">offset</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">limit</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span><span class="n">article</span><span class="p">]</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;routers.article.markdown.Markdown&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_markdown</span><span class="p">:</span>
            <span class="n">mock_md</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
            <span class="n">mock_md</span><span class="o">.</span><span class="n">convert</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;&lt;h1&gt;見出し&lt;/h1&gt;&lt;p&gt;本文です。&lt;/p&gt;&quot;</span>
            <span class="n">mock_markdown</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_md</span>
            
            <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">get_public_articles</span><span class="p">(</span><span class="n">mock_db</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            
            <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">body_html</span> <span class="o">==</span> <span class="s2">&quot;&lt;h1&gt;見出し&lt;/h1&gt;&lt;p&gt;本文です。&lt;/p&gt;&quot;</span>
            <span class="n">mock_markdown</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">extensions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;nl2br&#39;</span><span class="p">])</span>
            <span class="n">mock_md</span><span class="o">.</span><span class="n">convert</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;# 見出し</span><span class="se">\n\n</span><span class="s2">本文です。&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="TestGetPublicArticlesEndpoint.test_get_public_articles_database_error">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestGetPublicArticlesEndpoint.test_get_public_articles_database_error">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_get_public_articles_database_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;データベースエラーのテスト&quot;&quot;&quot;</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Database connection failed&quot;</span><span class="p">)</span>
        
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">HTTPException</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">get_public_articles</span><span class="p">(</span><span class="n">mock_db</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        
        <span class="k">assert</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
        <span class="k">assert</span> <span class="s2">&quot;記事の取得に失敗しました&quot;</span> <span class="ow">in</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">detail</span></div>
</div>



<div class="viewcode-block" id="TestSearchPublicArticlesEndpoint">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestSearchPublicArticlesEndpoint">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestSearchPublicArticlesEndpoint</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;search_public_articles エンドポイントのテスト&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="TestSearchPublicArticlesEndpoint.mock_db">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestSearchPublicArticlesEndpoint.mock_db">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mock_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;モックデータベースセッション&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">MagicMock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">Session</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="TestSearchPublicArticlesEndpoint.search_results">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestSearchPublicArticlesEndpoint.search_results">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">search_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;検索結果のサンプル&quot;&quot;&quot;</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">article</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
            <span class="n">article</span><span class="o">.</span><span class="n">article_id</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">article</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Python記事 </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">article</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Pythonプログラミングについて </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">articles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">articles</span></div>

    
<div class="viewcode-block" id="TestSearchPublicArticlesEndpoint.test_search_public_articles_single_keyword">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestSearchPublicArticlesEndpoint.test_search_public_articles_single_keyword">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_search_public_articles_single_keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">search_results</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;単一キーワード検索のテスト&quot;&quot;&quot;</span>
        <span class="n">mock_query</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">order_by</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">count</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">offset</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">limit</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">search_results</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;routers.article.markdown.Markdown&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_markdown</span><span class="p">:</span>
            <span class="n">mock_md</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
            <span class="n">mock_md</span><span class="o">.</span><span class="n">convert</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&lt;p&gt;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&lt;/p&gt;&quot;</span>
            <span class="n">mock_markdown</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_md</span>
            
            <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">search_public_articles</span><span class="p">(</span><span class="s2">&quot;Python&quot;</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">title</span> <span class="o">==</span> <span class="s2">&quot;Python記事 1&quot;</span></div>

    
<div class="viewcode-block" id="TestSearchPublicArticlesEndpoint.test_search_public_articles_multiple_keywords">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestSearchPublicArticlesEndpoint.test_search_public_articles_multiple_keywords">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_search_public_articles_multiple_keywords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">search_results</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;複数キーワード検索のテスト&quot;&quot;&quot;</span>
        <span class="n">mock_query</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">order_by</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">count</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">offset</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">limit</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">search_results</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;routers.article.markdown.Markdown&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_markdown</span><span class="p">:</span>
            <span class="n">mock_md</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
            <span class="n">mock_md</span><span class="o">.</span><span class="n">convert</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&lt;p&gt;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&lt;/p&gt;&quot;</span>
            <span class="n">mock_markdown</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_md</span>
            
            <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">search_public_articles</span><span class="p">(</span><span class="s2">&quot;Python プログラミング&quot;</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="c1"># 複数のfilterが呼ばれることを確認（ANDロジック）</span>
            <span class="k">assert</span> <span class="n">mock_query</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">call_count</span> <span class="o">&gt;=</span> <span class="mi">2</span></div>

    
<div class="viewcode-block" id="TestSearchPublicArticlesEndpoint.test_search_public_articles_japanese_keywords">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestSearchPublicArticlesEndpoint.test_search_public_articles_japanese_keywords">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_search_public_articles_japanese_keywords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">search_results</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;日本語キーワード検索のテスト&quot;&quot;&quot;</span>
        <span class="n">japanese_articles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">article</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
            <span class="n">article</span><span class="o">.</span><span class="n">article_id</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">article</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;プログラミング記事 </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">article</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;日本語でプログラミングについて </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">japanese_articles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
        
        <span class="n">mock_query</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">order_by</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">count</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">offset</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">limit</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">japanese_articles</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;routers.article.markdown.Markdown&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_markdown</span><span class="p">:</span>
            <span class="n">mock_md</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
            <span class="n">mock_md</span><span class="o">.</span><span class="n">convert</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&lt;p&gt;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&lt;/p&gt;&quot;</span>
            <span class="n">mock_markdown</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_md</span>
            
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;routers.article.urllib.parse.unquote&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_unquote</span><span class="p">:</span>
                <span class="n">mock_unquote</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;プログラミング&quot;</span>
                
                <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">search_public_articles</span><span class="p">(</span><span class="s2">&quot;プログラミング&quot;</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
                <span class="n">mock_unquote</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;プログラミング&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="TestSearchPublicArticlesEndpoint.test_search_public_articles_url_encoded">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestSearchPublicArticlesEndpoint.test_search_public_articles_url_encoded">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_search_public_articles_url_encoded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">search_results</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;URLエンコードされたキーワードのテスト&quot;&quot;&quot;</span>
        <span class="n">mock_query</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">order_by</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">count</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">offset</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">limit</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">search_results</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;routers.article.markdown.Markdown&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_markdown</span><span class="p">:</span>
            <span class="n">mock_md</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
            <span class="n">mock_md</span><span class="o">.</span><span class="n">convert</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&lt;p&gt;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&lt;/p&gt;&quot;</span>
            <span class="n">mock_markdown</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_md</span>
            
            <span class="c1"># URLエンコードされた日本語キーワード</span>
            <span class="n">encoded_keyword</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="s2">&quot;プログラミング&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            
            <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">search_public_articles</span><span class="p">(</span><span class="n">encoded_keyword</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span></div>

    
<div class="viewcode-block" id="TestSearchPublicArticlesEndpoint.test_search_public_articles_with_pagination">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestSearchPublicArticlesEndpoint.test_search_public_articles_with_pagination">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_search_public_articles_with_pagination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">search_results</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ページネーション付き検索のテスト&quot;&quot;&quot;</span>
        <span class="n">mock_query</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">order_by</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">count</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">offset</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">limit</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">search_results</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;routers.article.markdown.Markdown&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_markdown</span><span class="p">:</span>
            <span class="n">mock_md</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
            <span class="n">mock_md</span><span class="o">.</span><span class="n">convert</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&lt;p&gt;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&lt;/p&gt;&quot;</span>
            <span class="n">mock_markdown</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_md</span>
            
            <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">search_public_articles</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
            
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="n">mock_query</span><span class="o">.</span><span class="n">offset</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">mock_query</span><span class="o">.</span><span class="n">limit</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="TestSearchPublicArticlesEndpoint.test_search_public_articles_no_results">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestSearchPublicArticlesEndpoint.test_search_public_articles_no_results">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_search_public_articles_no_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;検索結果なしのテスト&quot;&quot;&quot;</span>
        <span class="n">mock_query</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">order_by</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">count</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">offset</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">limit</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;routers.article.markdown.Markdown&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_markdown</span><span class="p">:</span>
            <span class="n">mock_md</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
            <span class="n">mock_markdown</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_md</span>
            
            <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">search_public_articles</span><span class="p">(</span><span class="s2">&quot;存在しないキーワード&quot;</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            
            <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="p">[]</span></div>

    
<div class="viewcode-block" id="TestSearchPublicArticlesEndpoint.test_search_public_articles_database_error">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestSearchPublicArticlesEndpoint.test_search_public_articles_database_error">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_search_public_articles_database_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;データベースエラーのテスト&quot;&quot;&quot;</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Database connection failed&quot;</span><span class="p">)</span>
        
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">HTTPException</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">search_public_articles</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        
        <span class="k">assert</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
        <span class="k">assert</span> <span class="s2">&quot;記事検索に失敗しました&quot;</span> <span class="ow">in</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">detail</span></div>
</div>



<div class="viewcode-block" id="TestGetPublicArticleByIdEndpoint">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestGetPublicArticleByIdEndpoint">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestGetPublicArticleByIdEndpoint</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;get_public_article_by_id エンドポイントのテスト&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="TestGetPublicArticleByIdEndpoint.mock_db">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestGetPublicArticleByIdEndpoint.mock_db">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mock_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;モックデータベースセッション&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">MagicMock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">Session</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="TestGetPublicArticleByIdEndpoint.sample_article">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestGetPublicArticleByIdEndpoint.sample_article">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sample_article</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;サンプル記事&quot;&quot;&quot;</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">article</span><span class="o">.</span><span class="n">article_id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">article</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;パブリック記事詳細&quot;</span>
        <span class="n">article</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;# パブリック記事</span><span class="se">\n\n</span><span class="s2">これは詳細な記事です。&quot;</span>
        <span class="k">return</span> <span class="n">article</span></div>

    
<div class="viewcode-block" id="TestGetPublicArticleByIdEndpoint.test_get_public_article_by_id_success">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestGetPublicArticleByIdEndpoint.test_get_public_article_by_id_success">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_get_public_article_by_id_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">sample_article</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;記事詳細取得成功のテスト&quot;&quot;&quot;</span>
        <span class="n">mock_query</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">sample_article</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;routers.article.markdown.Markdown&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_markdown</span><span class="p">:</span>
            <span class="n">mock_md</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
            <span class="n">mock_md</span><span class="o">.</span><span class="n">convert</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;&lt;h1&gt;パブリック記事&lt;/h1&gt;&lt;p&gt;これは詳細な記事です。&lt;/p&gt;&quot;</span>
            <span class="n">mock_markdown</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_md</span>
            
            <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">get_public_article_by_id</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">))</span>
            
            <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">article_id</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">title</span> <span class="o">==</span> <span class="s2">&quot;パブリック記事詳細&quot;</span>
            <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">body_html</span> <span class="o">==</span> <span class="s2">&quot;&lt;h1&gt;パブリック記事&lt;/h1&gt;&lt;p&gt;これは詳細な記事です。&lt;/p&gt;&quot;</span>
            
            <span class="n">mock_markdown</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">extensions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;nl2br&#39;</span><span class="p">])</span>
            <span class="n">mock_md</span><span class="o">.</span><span class="n">convert</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;# パブリック記事</span><span class="se">\n\n</span><span class="s2">これは詳細な記事です。&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="TestGetPublicArticleByIdEndpoint.test_get_public_article_by_id_not_found">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestGetPublicArticleByIdEndpoint.test_get_public_article_by_id_not_found">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_get_public_article_by_id_not_found</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;記事が見つからない場合のテスト&quot;&quot;&quot;</span>
        <span class="n">mock_query</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">HTTPException</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">get_public_article_by_id</span><span class="p">(</span><span class="mi">999</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">))</span>
        
        <span class="k">assert</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
        <span class="k">assert</span> <span class="s2">&quot;記事ID 999 の記事が見つかりません&quot;</span> <span class="ow">in</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">detail</span></div>

    
<div class="viewcode-block" id="TestGetPublicArticleByIdEndpoint.test_get_public_article_by_id_database_error">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestGetPublicArticleByIdEndpoint.test_get_public_article_by_id_database_error">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_get_public_article_by_id_database_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;データベースエラーのテスト&quot;&quot;&quot;</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Database connection failed&quot;</span><span class="p">)</span>
        
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">HTTPException</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">get_public_article_by_id</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">))</span>
        
        <span class="k">assert</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
        <span class="k">assert</span> <span class="s2">&quot;記事詳細の取得に失敗しました&quot;</span> <span class="ow">in</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">detail</span></div>

    
<div class="viewcode-block" id="TestGetPublicArticleByIdEndpoint.test_get_public_article_by_id_markdown_conversion">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestGetPublicArticleByIdEndpoint.test_get_public_article_by_id_markdown_conversion">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_get_public_article_by_id_markdown_conversion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;複雑なMarkdown変換のテスト&quot;&quot;&quot;</span>
        <span class="n">complex_article</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">complex_article</span><span class="o">.</span><span class="n">article_id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">complex_article</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;複雑なMarkdown&quot;</span>
        <span class="n">complex_article</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;# 見出し1</span><span class="se">\n\n</span><span class="s2">## 見出し2</span><span class="se">\n\n</span><span class="s2">**太字**と*斜体*</span><span class="se">\n\n</span><span class="s2">- リスト1</span><span class="se">\n</span><span class="s2">- リスト2&quot;</span>
        
        <span class="n">mock_query</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">complex_article</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;routers.article.markdown.Markdown&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_markdown</span><span class="p">:</span>
            <span class="n">mock_md</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
            <span class="n">expected_html</span> <span class="o">=</span> <span class="s2">&quot;&lt;h1&gt;見出し1&lt;/h1&gt;&lt;h2&gt;見出し2&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;太字&lt;/strong&gt;と&lt;em&gt;斜体&lt;/em&gt;&lt;/p&gt;&lt;ul&gt;&lt;li&gt;リスト1&lt;/li&gt;&lt;li&gt;リスト2&lt;/li&gt;&lt;/ul&gt;&quot;</span>
            <span class="n">mock_md</span><span class="o">.</span><span class="n">convert</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">expected_html</span>
            <span class="n">mock_markdown</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_md</span>
            
            <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">get_public_article_by_id</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">))</span>
            
            <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">body_html</span> <span class="o">==</span> <span class="n">expected_html</span>
            <span class="n">mock_md</span><span class="o">.</span><span class="n">convert</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">complex_article</span><span class="o">.</span><span class="n">body</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TestArticleRouterIntegration">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestArticleRouterIntegration">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestArticleRouterIntegration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;記事ルーターの統合テスト&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="TestArticleRouterIntegration.client">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestArticleRouterIntegration.client">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;テストクライアント&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="TestArticleRouterIntegration.test_router_configuration">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestArticleRouterIntegration.test_router_configuration">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_router_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ルーター設定の詳細テスト&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">router</span><span class="o">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="s2">&quot;/api/v1&quot;</span>
        <span class="k">assert</span> <span class="s2">&quot;articles&quot;</span> <span class="ow">in</span> <span class="n">router</span><span class="o">.</span><span class="n">tags</span>
        
        <span class="c1"># エンドポイントの数を確認</span>
        <span class="n">routes</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">routes</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">routes</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span>  <span class="c1"># 最低6つのエンドポイント</span></div>

    
<div class="viewcode-block" id="TestArticleRouterIntegration.test_public_endpoints_no_auth_required">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestArticleRouterIntegration.test_public_endpoints_no_auth_required">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_public_endpoints_no_auth_required</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;パブリックエンドポイントは認証不要であることを確認&quot;&quot;&quot;</span>
        <span class="n">public_routes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">route</span> <span class="k">for</span> <span class="n">route</span> <span class="ow">in</span> <span class="n">router</span><span class="o">.</span><span class="n">routes</span> 
            <span class="k">if</span> <span class="s2">&quot;/public/&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">route</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="p">]</span>
        
        <span class="c1"># パブリックルートが存在することを確認</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">public_routes</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span></div>

    
<div class="viewcode-block" id="TestArticleRouterIntegration.test_private_endpoints_auth_required">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestArticleRouterIntegration.test_private_endpoints_auth_required">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_private_endpoints_auth_required</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;プライベートエンドポイントは認証が必要であることを確認&quot;&quot;&quot;</span>
        <span class="c1"># 認証が必要なルートのパスパターン</span>
        <span class="n">private_patterns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;/articles&quot;</span><span class="p">,</span> <span class="s2">&quot;/articles/</span><span class="si">{id}</span><span class="s2">&quot;</span><span class="p">]</span>
        
        <span class="n">private_routes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">route</span> <span class="k">for</span> <span class="n">route</span> <span class="ow">in</span> <span class="n">router</span><span class="o">.</span><span class="n">routes</span> 
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">pattern</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">route</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">private_patterns</span><span class="p">)</span>
            <span class="ow">and</span> <span class="s2">&quot;/public/&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">route</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="p">]</span>
        
        <span class="c1"># プライベートルートが存在することを確認</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">private_routes</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span></div>
</div>



<div class="viewcode-block" id="TestArticleRouterEdgeCases">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestArticleRouterEdgeCases">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestArticleRouterEdgeCases</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;記事ルーターのエッジケースのテスト&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="TestArticleRouterEdgeCases.mock_db">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestArticleRouterEdgeCases.mock_db">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mock_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;モックデータベースセッション&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">MagicMock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">Session</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="TestArticleRouterEdgeCases.mock_current_user">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestArticleRouterEdgeCases.mock_current_user">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mock_current_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;モック現在ユーザー&quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">123</span>
        <span class="k">return</span> <span class="n">user</span></div>

    
<div class="viewcode-block" id="TestArticleRouterEdgeCases.test_all_fetch_very_large_limit">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestArticleRouterEdgeCases.test_all_fetch_very_large_limit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_all_fetch_very_large_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;非常に大きな制限値のテスト&quot;&quot;&quot;</span>
        <span class="n">mock_query</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">count</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">limit</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        
        <span class="c1"># 非常に大きな制限値でもエラーにならないことを確認</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">all_fetch</span><span class="p">(</span><span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">,</span> <span class="mi">999999</span><span class="p">))</span>
        
        <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="p">[]</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">limit</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="mi">999999</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="TestArticleRouterEdgeCases.test_search_with_special_characters">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestArticleRouterEdgeCases.test_search_with_special_characters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_search_with_special_characters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;特殊文字での検索テスト&quot;&quot;&quot;</span>
        <span class="n">mock_query</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">order_by</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">count</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">offset</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">limit</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;routers.article.markdown.Markdown&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_markdown</span><span class="p">:</span>
            <span class="n">mock_md</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
            <span class="n">mock_markdown</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_md</span>
            
            <span class="c1"># 特殊文字を含む検索でもエラーにならないことを確認</span>
            <span class="n">special_chars</span> <span class="o">=</span> <span class="s2">&quot;!@#$%^&amp;*()_+-=[]</span><span class="si">{}</span><span class="s2">|;:,.&lt;&gt;?&quot;</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">search_public_articles</span><span class="p">(</span><span class="n">special_chars</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            
            <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="p">[]</span></div>

    
<div class="viewcode-block" id="TestArticleRouterEdgeCases.test_markdown_with_empty_content">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestArticleRouterEdgeCases.test_markdown_with_empty_content">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_markdown_with_empty_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;空のMarkdownコンテンツのテスト&quot;&quot;&quot;</span>
        <span class="n">empty_article</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">empty_article</span><span class="o">.</span><span class="n">article_id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">empty_article</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;空の記事&quot;</span>
        <span class="n">empty_article</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        
        <span class="n">mock_query</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        <span class="n">mock_query</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">empty_article</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_query</span>
        
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;routers.article.markdown.Markdown&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_markdown</span><span class="p">:</span>
            <span class="n">mock_md</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
            <span class="n">mock_md</span><span class="o">.</span><span class="n">convert</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">mock_markdown</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_md</span>
            
            <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">get_public_article_by_id</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">))</span>
            
            <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">body_html</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span>
            <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">title</span> <span class="o">==</span> <span class="s2">&quot;空の記事&quot;</span></div>

    
<div class="viewcode-block" id="TestArticleRouterEdgeCases.test_create_article_with_unicode_content">
<a class="viewcode-back" href="../../tests.test_article_router.html#tests.test_article_router.TestArticleRouterEdgeCases.test_create_article_with_unicode_content">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_article_with_unicode_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Unicode文字を含む記事作成のテスト&quot;&quot;&quot;</span>
        <span class="n">unicode_article</span> <span class="o">=</span> <span class="n">ArticleBase</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Unicode記事 🎉 テスト&quot;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s2">&quot;これは絵文字 🚀 と特殊文字 àáâãäå を含む記事です。&quot;</span>
        <span class="p">)</span>
        
        <span class="n">mock_db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">scalar</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="n">new_article</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">new_article</span><span class="o">.</span><span class="n">article_id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">new_article</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">unicode_article</span><span class="o">.</span><span class="n">title</span>
        <span class="n">new_article</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">unicode_article</span><span class="o">.</span><span class="n">body</span>
        <span class="n">new_article</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="mi">123</span>
        
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;routers.article.Article&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_article_class</span><span class="p">:</span>
            <span class="n">mock_article_class</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">new_article</span>
            
            <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">create_article</span><span class="p">(</span><span class="n">unicode_article</span><span class="p">,</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_current_user</span><span class="p">))</span>
            
            <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">title</span> <span class="o">==</span> <span class="s2">&quot;Unicode記事 🎉 テスト&quot;</span>
            <span class="k">assert</span> <span class="s2">&quot;🚀&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">body</span>
            <span class="k">assert</span> <span class="s2">&quot;àáâãäå&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">body</span></div>
</div>



<span class="c1"># テスト実行用の設定</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">main</span><span class="p">([</span><span class="vm">__file__</span><span class="p">,</span> <span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="s2">&quot;--tb=short&quot;</span><span class="p">])</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">blog-api-main</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../custom_token.html">custom_token module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../database.html">database module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generate_summary_report.html">generate_summary_report module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hashing.html">hashing module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logger.html">logger package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../main.html">main module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../models.html">models module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../oauth2.html">oauth2 module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../routers.html">routers package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../run_continuous_tests.html">run_continuous_tests module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../schemas.html">schemas module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tests.html">tests package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../update_main_bug_history.html">update_main_bug_history module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utils.html">utils package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Author.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>