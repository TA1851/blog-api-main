<!DOCTYPE html>

<html lang="ja" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>routers.user &#8212; Blog API  ドキュメント</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/classic.css?v=2bf1fcf8" />
    
    <script src="../../_static/documentation_options.js?v=c033477b"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/translations.js?v=4755f45a"></script>
    
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="検索" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="総合索引"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Blog API  ドキュメント</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">モジュールコード</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">routers.user</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>routers.user のソースコード</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;ユーザ認証機能を実装するためのルーターモジュール&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">Query</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">uuid4</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">unquote</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">schemas</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span> <span class="k">as</span> <span class="n">UserSchema</span><span class="p">,</span> <span class="n">AccountDeletionRequest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span> <span class="k">as</span> <span class="n">UserModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">models</span><span class="w"> </span><span class="kn">import</span> <span class="n">EmailVerification</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_db</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hashing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Hash</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">oauth2</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_current_user</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">logger.custom_logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_logger</span><span class="p">,</span> <span class="n">create_error_logger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">utils.email_sender</span><span class="w"> </span><span class="kn">import</span> <span class="n">send_verification_email</span><span class="p">,</span> <span class="n">send_account_deletion_email</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">utils.email_validator</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_valid_email_domain</span>


<span class="c1"># APIレスポンスの型定義</span>
<span class="n">UserCreateResponse</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
<span class="n">UserDeleteResponse</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
<span class="n">UserUpdateResponse</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>


<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">(</span>
    <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/api/v1&quot;</span><span class="p">,</span>
    <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">],</span>
<span class="p">)</span>


<div class="viewcode-block" id="check_environment_variable">
<a class="viewcode-back" href="../../routers.html#routers.user.check_environment_variable">[ドキュメント]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_environment_variable</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;環境変数を取得する</span>

<span class="sd">    :param key08: user.pyの環境変数</span>

<span class="sd">    :type key08: str</span>

<span class="sd">    :return: 環境変数の値</span>

<span class="sd">    :rtype: str</span>
<span class="sd">    &quot;&quot;&quot;</span></div>


<span class="n">check_environment_variable</span><span class="p">()</span>


<div class="viewcode-block" id="check_db_url">
<a class="viewcode-back" href="../../routers.html#routers.user.check_db_url">[ドキュメント]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_db_url</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;データベースURLを取得する</span>

<span class="sd">    :param key03: user.pyの環境変数</span>

<span class="sd">    :type key03: str</span>

<span class="sd">    :param db_url: user.pyの環境変数</span>

<span class="sd">    :type db_url: str</span>

<span class="sd">    :return: 環境変数の値</span>

<span class="sd">    :rtype: str</span>
<span class="sd">    &quot;&quot;&quot;</span></div>


<span class="n">check_db_url</span><span class="p">()</span>
<span class="n">get_db</span><span class="p">()</span>


<div class="viewcode-block" id="IntegrityError">
<a class="viewcode-back" href="../../routers.html#routers.user.IntegrityError">[ドキュメント]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">IntegrityError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;主にユニーク制約違反（メールアドレスが既に使用されている場合など）を示すエラー&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="SQLAlchemyError">
<a class="viewcode-back" href="../../routers.html#routers.user.SQLAlchemyError">[ドキュメント]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SQLAlchemyError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;データベース関連のエラー&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>



<span class="c1"># 環境変数の読み込む</span>
<span class="n">ALLOWED_EMAIL_DOMAINS_RAW</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ALLOWED_EMAIL_DOMAINS&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">ALLOWED_EMAIL_DOMAINS</span> <span class="o">=</span> <span class="p">[</span><span class="n">domain</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">ALLOWED_EMAIL_DOMAINS_RAW</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">domain</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
<span class="n">ENABLE_DOMAIN_RESTRICTION</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ENABLE_DOMAIN_RESTRICTION&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span>
<span class="n">ENABLE_EMAIL_VERIFICATION</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ENABLE_EMAIL_VERIFICATION&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span>

<span class="c1"># デバッグ情報</span>
<span class="n">create_logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[修正後] 環境変数ALLOWED_EMAIL_DOMAINS_RAW: &#39;</span><span class="si">{</span><span class="n">ALLOWED_EMAIL_DOMAINS_RAW</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<span class="n">create_logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[修正後] 解析後のALLOWED_EMAIL_DOMAINS: </span><span class="si">{</span><span class="n">ALLOWED_EMAIL_DOMAINS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">create_logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[修正後] ENABLE_DOMAIN_RESTRICTION: </span><span class="si">{</span><span class="n">ENABLE_DOMAIN_RESTRICTION</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="create_user">
<a class="viewcode-back" href="../../routers.html#routers.user.create_user">[ドキュメント]</a>
<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
    <span class="s2">&quot;/user&quot;</span><span class="p">,</span>
    <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">,</span>
    <span class="n">response_model</span><span class="o">=</span><span class="n">UserSchema</span><span class="p">,</span>
    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;User Create&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;ユーザーを作成するエンドポイント。&quot;</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span>
    <span class="n">user</span><span class="p">:</span> <span class="n">UserSchema</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">)</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UserCreateResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ユーザーを作成するエンドポイント</span>

<span class="sd">    ユーザーは登録後にパスワード変更エンドポイントでパスワードを設定する必要があります。</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># 入力データの検証</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span>
                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;メールアドレスが必要です。&quot;</span>
            <span class="p">)</span>
        <span class="n">create_logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ユーザー作成開始 - メール: </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># ドメイン制限チェック</span>
        <span class="k">if</span> <span class="n">ENABLE_DOMAIN_RESTRICTION</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_valid_email_domain</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">):</span>
            <span class="n">create_error_logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ドメイン検証失敗 - メール: </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span>
                <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;このメールアドレスのドメインは許可されていません。許可されたドメイン: </span><span class="se">\</span>
<span class="s2">                </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ALLOWED_EMAIL_DOMAINS</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># メールアドレスの重複チェック</span>
        <span class="n">existing_user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">UserModel</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">UserModel</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
        <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">existing_user</span><span class="p">:</span>
            <span class="n">create_error_logger</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;既存のメールアドレスが検出されました: </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_409_CONFLICT</span><span class="p">,</span>
                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;このメールアドレスは既に使用されています。&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">ENABLE_EMAIL_VERIFICATION</span><span class="p">:</span>
            <span class="c1"># メール認証が有効な場合の従来の処理</span>
            <span class="n">existing_verification</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">EmailVerification</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">EmailVerification</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
            <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">existing_verification</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">existing_verification</span><span class="o">.</span><span class="n">is_verified</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_409_CONFLICT</span><span class="p">,</span>
                        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;このメールアドレスは既に確認済みです。&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># 既存のレコードを更新（メールアドレスのみ）</span>
                    <span class="n">existing_verification</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
                    <span class="n">existing_verification</span><span class="o">.</span><span class="n">created_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
                    <span class="n">existing_verification</span><span class="o">.</span><span class="n">expires_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
                    <span class="n">verification</span> <span class="o">=</span> <span class="n">existing_verification</span>
                    <span class="n">create_logger</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;既存の確認レコードを更新しました: </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">verification</span> <span class="o">=</span> <span class="n">EmailVerification</span><span class="o">.</span><span class="n">create_verification</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">verification</span><span class="p">)</span>
                <span class="n">create_logger</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;新しい確認レコードを作成しました: </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">send_verification_email</span><span class="p">(</span>
                <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">verification</span><span class="o">.</span><span class="n">token</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;ユーザー登録を受け付けました。確認メールをお送りしましたので、メール内のリンクをクリックして登録を完了してください。&quot;</span><span class="p">,</span>
                <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># メール認証が無効な場合の直接ユーザー作成</span>
            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span>
                    <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;メールアドレスが必要です。&quot;</span>
                <span class="p">)</span>
            <span class="c1"># 仮パスワードを生成</span>
            <span class="n">temp_password</span> <span class="o">=</span> <span class="s2">&quot;temp_password_123&quot;</span>
            <span class="n">new_user</span> <span class="o">=</span> <span class="n">UserModel</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="k">else</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">email</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                <span class="n">password</span><span class="o">=</span><span class="n">Hash</span><span class="o">.</span><span class="n">bcrypt</span><span class="p">(</span><span class="n">temp_password</span><span class="p">),</span>
                <span class="n">is_active</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">db</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>
            <span class="n">create_logger</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ユーザーを直接作成しました: </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;ユーザー登録が完了しました。仮パスワード &#39;temp_password_123&#39; でログインして、パスワードを変更してください。&quot;</span><span class="p">,</span>
                <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_user</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
                <span class="s2">&quot;is_active&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_user</span><span class="o">.</span><span class="n">is_active</span><span class="p">)</span>
            <span class="p">}</span>

    <span class="k">except</span> <span class="n">HTTPException</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="k">raise</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">error_detail</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">create_error_logger</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;不明なエラーが発生しました: </span><span class="si">{</span><span class="n">error_detail</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;予期しないエラーが発生しました。&quot;</span>
        <span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">create_logger</span><span class="p">(</span>
            <span class="s2">&quot;DBセッションをクローズします&quot;</span>
            <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<div class="viewcode-block" id="verify_email">
<a class="viewcode-back" href="../../routers.html#routers.user.verify_email">[ドキュメント]</a>
<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
    <span class="s2">&quot;/verify-email&quot;</span><span class="p">,</span>
    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Email Verification&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;ユーザーのメールアドレスを確認するエンドポイント&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">verify_email</span><span class="p">(</span>
    <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="o">...</span><span class="p">),</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">)</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="c1"># デバッグログを追加</span>
    <span class="n">create_logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;メール認証リクエスト受信 - 元のトークン: </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># URLデコード処理（安全性を確保）</span>
    <span class="n">decoded_token</span> <span class="o">=</span> <span class="n">unquote</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="n">create_logger</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;メール認証リクエスト受信 - デコード後トークン: </span><span class="si">{</span><span class="n">decoded_token</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="c1"># トークンの形式チェック</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">decoded_token</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">decoded_token</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">create_error_logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;無効なトークン形式: </span><span class="si">{</span><span class="n">decoded_token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;無効なトークン形式です。&quot;</span>
        <span class="p">)</span>

    <span class="n">verification</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">EmailVerification</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">EmailVerification</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="n">decoded_token</span>
    <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">verification</span><span class="p">:</span>
        <span class="c1"># データベース内の全トークンを確認</span>
        <span class="n">all_verifications</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">EmailVerification</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">create_logger</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;データベース内のトークン数: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_verifications</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">all_verifications</span><span class="p">:</span>
            <span class="n">create_logger</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;DB内トークン: </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">token</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span><span class="si">}</span><span class="s2">..., Email: </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2">, 確認済み: </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">is_verified</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="n">create_error_logger</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;トークンが見つかりません: </span><span class="si">{</span><span class="n">decoded_token</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span>
            <span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;無効なトークンです。&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">verification</span><span class="o">.</span><span class="n">is_verified</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;このメールアドレスは既に確認済みです。&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">verification</span><span class="o">.</span><span class="n">expires_at</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">verification</span><span class="o">.</span><span class="n">expires_at</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;トークンの有効期限が切れています。&quot;</span>
        <span class="p">)</span>
    <span class="c1"># 初期パスワード</span>
    <span class="n">user_password</span> <span class="o">=</span> <span class="n">verification</span><span class="o">.</span><span class="n">password_hash</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span>
        <span class="n">verification</span><span class="p">,</span> <span class="s1">&#39;password_hash&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">verification</span><span class="o">.</span><span class="n">password_hash</span> \
        <span class="k">else</span> <span class="n">Hash</span><span class="o">.</span><span class="n">bcrypt</span><span class="p">(</span><span class="s2">&quot;temp_password_123&quot;</span><span class="p">)</span>

    <span class="c1"># ユーザーの作成</span>
    <span class="n">new_user</span> <span class="o">=</span> <span class="n">UserModel</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">verification</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>  <span class="c1"># @の前の部分をユーザー名に設定</span>
        <span class="n">email</span><span class="o">=</span><span class="n">verification</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="n">user_password</span><span class="p">,</span>
        <span class="n">is_active</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">verification</span><span class="o">.</span><span class="n">is_verified</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;メールアドレスの確認が完了しました。仮パスワードを変更して登録を完了してください。&quot;</span><span class="p">,</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">verification</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
        <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">new_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="s2">&quot;is_active&quot;</span><span class="p">:</span> <span class="n">new_user</span><span class="o">.</span><span class="n">is_active</span>
    <span class="p">}</span></div>



<span class="c1"># カスタム例外クラス（ユーザ関連）</span>
<div class="viewcode-block" id="UserNotFoundError">
<a class="viewcode-back" href="../../routers.html#routers.user.UserNotFoundError">[ドキュメント]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">UserNotFoundError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ユーザーが見つからない場合の例外&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">user_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;User with id </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> not found&quot;</span>
        <span class="k">elif</span> <span class="n">email</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;User with email </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2"> not found&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;User not found&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>



<div class="viewcode-block" id="EmailVerificationError">
<a class="viewcode-back" href="../../routers.html#routers.user.EmailVerificationError">[ドキュメント]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EmailVerificationError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;メール確認に関する例外&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>



<div class="viewcode-block" id="DatabaseError">
<a class="viewcode-back" href="../../routers.html#routers.user.DatabaseError">[ドキュメント]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DatabaseError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;データベース関連の例外&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>



<div class="viewcode-block" id="show_user">
<a class="viewcode-back" href="../../routers.html#routers.user.show_user">[ドキュメント]</a>
<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
    <span class="s2">&quot;/user/</span><span class="si">{user_id}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">response_model</span><span class="o">=</span><span class="n">UserSchema</span><span class="p">,</span>
    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Get User (Authentication Required)&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;認証が必要なユーザー情報取得エンドポイント。ユーザーは自分自身の情報のみ取得可能。&quot;</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_user</span><span class="p">(</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">),</span>
    <span class="n">current_user</span><span class="p">:</span> <span class="n">UserModel</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UserSchema</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ユーザー情報を取得する関数（認証が必要）</span>

<span class="sd">    :param user_id: ユーザーID</span>

<span class="sd">    :type user_id: int</span>

<span class="sd">    :param db: データベースセッション</span>

<span class="sd">    :type db: Session</span>

<span class="sd">    :param current_user: 現在ログインしているユーザー</span>

<span class="sd">    :type current_user: UserModel</span>

<span class="sd">    :return: ユーザー情報</span>

<span class="sd">    :rtype: UserSchema</span>

<span class="sd">    :raises HTTPException: ユーザーが見つからない場合</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 認証されたユーザーが自分以外の情報にアクセスしようとしていないかチェック</span>
    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">user_id</span><span class="p">:</span>
        <span class="n">create_error_logger</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">            tried to access user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&#39;s information&quot;</span>
            <span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;他のユーザーの情報にはアクセスできません&quot;</span>
        <span class="p">)</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">UserModel</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">UserModel</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="n">create_error_logger</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;User with id </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> not found&quot;</span>
            <span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;User with id </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> not found&quot;</span>
        <span class="p">)</span>
    <span class="n">create_logger</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;認証されたユーザー </span><span class="si">{</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">        がユーザー情報を取得しました: </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="c1"># SQLAlchemyモデルをPydanticスキーマに変換</span>
    <span class="k">return</span> <span class="n">UserSchema</span><span class="p">(</span>
        <span class="n">email</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">is_active</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">is_active</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="resend_verification_email">
<a class="viewcode-back" href="../../routers.html#routers.user.resend_verification_email">[ドキュメント]</a>
<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
<span class="s2">&quot;/resend-verification&quot;</span><span class="p">,</span>
<span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Resend Verification Email&quot;</span><span class="p">,</span>
<span class="n">description</span><span class="o">=</span><span class="s2">&quot;登録確認メールを送信するエンドポイント&quot;</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">resend_verification_email</span><span class="p">(</span>
    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">)</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;登録確認メールを送信する&quot;&quot;&quot;</span>
    <span class="n">verification</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">EmailVerification</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">EmailVerification</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">email</span><span class="p">,</span>
        <span class="n">EmailVerification</span><span class="o">.</span><span class="n">is_verified</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">verification</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;確認待ちのメールアドレスが見つかりません。&quot;</span>
        <span class="p">)</span>
    <span class="c1"># 新しいトークンを生成</span>
    <span class="n">verification</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="n">verification</span><span class="o">.</span><span class="n">created_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
    <span class="n">verification</span><span class="o">.</span><span class="n">expires_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">send_verification_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">verification</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;確認メールを再送信しました。&quot;</span><span class="p">}</span></div>



<div class="viewcode-block" id="delete_user_account">
<a class="viewcode-back" href="../../routers.html#routers.user.delete_user_account">[ドキュメント]</a>
<span class="nd">@router</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
    <span class="s2">&quot;/user/delete-account&quot;</span><span class="p">,</span>
    <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">,</span>
    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Delete User Account&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;ユーザーアカウントに関連するデータを削除するエンドポイント&quot;</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete_user_account</span><span class="p">(</span>
    <span class="n">deletion_request</span><span class="p">:</span> <span class="n">AccountDeletionRequest</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">),</span>
    <span class="n">current_user</span><span class="p">:</span> <span class="n">UserModel</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ユーザーアカウントを削除するエンドポイント（認証必須）</span>

<span class="sd">    このエンドポイントは認証されたユーザーのみアクセス可能で、</span>
<span class="sd">    ユーザーは自分のアカウントのみ削除できます。</span>

<span class="sd">    :param deletion_request: 退会リクエストデータ</span>

<span class="sd">    :type deletion_request: アカウント削除リクエスト</span>

<span class="sd">    :deletion_request.validate_passwords_match</span>

<span class="sd">    :パスワードの一致を検証するメソッド</span>

<span class="sd">    :type deletion_request.validate_passwords_match: method</span>

<span class="sd">    :param db: データベースセッション</span>

<span class="sd">    :type db: Session</span>

<span class="sd">    :param current_user: 現在の認証されたユーザー</span>

<span class="sd">    :type current_user: UserModel</span>

<span class="sd">    :return: 退会完了メッセージ</span>

<span class="sd">    :rtype: dict</span>

<span class="sd">    :raises HTTPException: ユーザーが見つからない、パスワードが間違っている、認証エラー、権限なしの場合</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">create_logger</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;退会処理開始 - メール: </span><span class="se">\</span>
<span class="s2">            </span><span class="si">{</span><span class="n">deletion_request</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2">, </span><span class="se">\</span>
<span class="s2">            認証ユーザー: </span><span class="si">{</span><span class="n">current_user</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="c1"># パスワード一致チェック</span>
        <span class="n">deletion_request</span><span class="o">.</span><span class="n">validate_passwords_match</span><span class="p">()</span>
        <span class="c1"># 認証されたユーザーが削除対象のユーザーと同じかチェック</span>
        <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">email</span> <span class="o">!=</span> <span class="n">deletion_request</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>
            <span class="n">create_error_logger</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;権限なし: 認証ユーザー(</span><span class="si">{</span><span class="n">current_user</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2">) </span><span class="se">\</span>
<span class="s2">                が他のユーザー(</span><span class="si">{</span><span class="n">deletion_request</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2">)のアカウント削除を試行&quot;</span>
                <span class="p">)</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span><span class="p">,</span>
                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;自分のアカウントのみ削除できます&quot;</span>
            <span class="p">)</span>
        <span class="c1"># ユーザーの存在確認（認証されたユーザーと同じなので基本的には存在するはず）</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">UserModel</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">UserModel</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">deletion_request</span><span class="o">.</span><span class="n">email</span>
        <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">create_error_logger</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;退会対象ユーザーが見つかりません: </span><span class="si">{</span><span class="n">deletion_request</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">,</span>
                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;指定されたメールアドレスのユーザーが見つかりません&quot;</span>
            <span class="p">)</span>
        <span class="c1"># パスワード検証</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span>
                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;ユーザーのパスワードが設定されていません&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">deletion_request</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">):</span>
            <span class="n">create_error_logger</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;パスワード検証失敗: </span><span class="si">{</span><span class="n">deletion_request</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;パスワードが正しくありません&quot;</span>
            <span class="p">)</span>
        <span class="c1"># ユーザー名を保存（メール送信用）</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span>
                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;ユーザーのメールアドレスが見つかりません。&quot;</span>
            <span class="p">)</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">user_email</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
        <span class="n">create_logger</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;ユーザー検証完了: </span><span class="si">{</span><span class="n">user_email</span><span class="si">}</span><span class="s2">, ID: </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="c1"># ユーザーの記事を削除</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Article</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Article</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Article</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">article_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">articles</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">article</span> <span class="ow">in</span> <span class="n">articles</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
        <span class="n">create_logger</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;ユーザーの記事を削除しました: </span><span class="si">{</span><span class="n">article_count</span><span class="si">}</span><span class="s2">件&quot;</span>
            <span class="p">)</span>
        <span class="c1"># メール認証テーブルからも削除</span>
        <span class="n">verification_records</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">EmailVerification</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">EmailVerification</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">user_email</span>
        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">verification</span> <span class="ow">in</span> <span class="n">verification_records</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">verification</span><span class="p">)</span>
        <span class="n">create_logger</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;メール認証レコードを削除しました: </span><span class="se">\</span>
<span class="s2">            </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">verification_records</span><span class="p">)</span><span class="si">}</span><span class="s2">件&quot;</span>
            <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">create_logger</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;ユーザーアカウント削除完了: </span><span class="si">{</span><span class="n">user_email</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="c1"># 退会完了メールを送信</span>
        <span class="k">await</span> <span class="n">send_account_deletion_email</span><span class="p">(</span><span class="n">user_email</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;退会処理が完了しました。退会完了メールをお送りしました。&quot;</span><span class="p">,</span>
            <span class="s2">&quot;deleted_articles_count&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">article_count</span><span class="p">),</span>
            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">user_email</span>
        <span class="p">}</span>
    <span class="k">except</span> <span class="n">HTTPException</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">create_error_logger</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;バリデーションエラー: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">error_detail</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">create_error_logger</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;退会処理で予期しないエラーが発生しました: </span><span class="si">{</span><span class="n">error_detail</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;退会処理中に予期しないエラーが発生しました&quot;</span>
        <span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">create_logger</span><span class="p">(</span>
            <span class="s2">&quot;DBセッションをクローズします&quot;</span>
            <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="検索" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="総合索引"
             >索引</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Blog API  ドキュメント</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >モジュールコード</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">routers.user</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; 著作権 2025, TA1851.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    </div>
  </body>
</html>